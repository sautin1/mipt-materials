# Домашнее задание 4. Оценка межкадровых сдвигов (глобального вектора перемещения)

## Описание репозитория
* Директория *src* содержит исходный код решения на C++.
* В файле *result.csv* указаны оценки глобальных векторов перемещения. Каждый вектор представлен парой чисел. В строчке i (i = 2..13) указан глобальный вектор перемещения фрейма (i-1) относительно фрейма 0.
* В файле *time_measurements.png* находится график зависимости времени работы алгоритма от номера рассматриваемого фрейма.

## Запуск
```sh
./motion_vector PATH_TO_DIRECTORY [--visualize] [--time]
```

Если указать флаг `--visualize`, то для каждой пары фреймов будут показаны два изображения:
* найденные локальные векторы для каждого блока;
* блоки и соответствующие им локальные векторы, выбранные для оценки глобального вектора перемещения.

Если указать флаг `--time`, то помимо межкадровых сдвигов будет выведено и время (в микросекундах), затраченное на обработку каждого фрейма.

## Краткое описание алгоритма
Алгоритм оценки межкадровых сдвигов для пары произвольных фреймов можно разбить на 3 последовательные стадии:
1. Нахождение локальных векторов перемещения. Текущий фрейм разбивается на непересекающиеся блоки, затем для каждого блока находится наиболее похожий на него блок в предыдущем фрейме; на основе этой пары блоков вычисляется межкадровый сдвиг блока, т.е. локальный вектор перемещения. За основу был взят алгоритм TDL (Two Dimensional Logarithmic Search).
2. Фильтрация локальных векторов. Для каждого локального вектора перемещения вычисляется функция доверия, учитывающая дисперсию внутри блока (*т.к. оценивать движение по фоновым блокам сложно, логичнее выбирать такие блоки, в которых есть какие-то объекты, отличающиеся по интенсивности от фона, например, символы текста*), а также отклонение локальных векторов соседних блоков от текущего (*если вектор сильно отличается от векторов соседних блоков, то этому вектору не стоит доверять при оценке глобального вектора*). Затем для дальнейшей обработки отбираются лишь те векторы, значение функции доверия для которых больше некоторого порога. Порог вычисляется так, чтобы хотя бы один вектор был отобран (берется максимальное значение функции доверия по всем локальным векторам и домножается на 70%).
3. Оценка глобального вектора перемещения. Значения локальных векторов, выбранных на стадии 2, усредняются покоординатно, давая оценку на глобальный вектор перемещения.

Оценка глобального вектора перемещения фрейма i (i > 0) относительно нулевого фрейма производится так:  
A. Находятся локальные векторы `local_vectors_previous` для i-ого и (i-1)-ого фреймов (стадии 1-2 алгоритма).  
B. Находятся локальные векторы `local_vectors_first` для i-ого и 0-ого фреймов (стадии 1-2 алгоритма).  
C. Из двух наборов векторов (`local_vectors_previous` и `local_vectors_first`) выбирается тот, дисперсия которого меньше. Затем на его основе оценивается глобальный вектор перемещения (стадия 3 алгоритма).

## Оценка сложности алгоритма
Обозначения:  
`bc` -- block count -- количество блоков в фрейме;  
`bs` -- block size -- размер блока (длина стороны квадратного блока);


Стадия 1: в ходе работы TDL в худшем случае будут просмотрены ![](https://latex.codecogs.com/gif.latex?\inline&space;O(bc)) блоков предыдущего фрейма, для каждого из которых будет посчитано расстояние до текущего блока за ![](https://latex.codecogs.com/gif.latex?\inline&space;O(bs^2)). Итого: ![Сложность стадии 1](https://latex.codecogs.com/gif.latex?\inline&space;O(bc&space;\cdot&space;bs^2)&space;=&space;O(\frac{W}{bs}&space;\cdot&space;\frac{H}{bs}&space;\cdot&space;bs^2)&space;=&space;O(W\cdot&space;H)).

Стадии 2 и 3 также выполняются за ![Сложность стадий 2 и 3](https://latex.codecogs.com/gif.latex?\inline&space;O(W\cdot&space;H)).

Итоговая сложность алгоритма: ![Сложность алгоритма](https://latex.codecogs.com/gif.latex?\inline&space;O(W\cdot&space;H)).

## Источники
1. [Wikipedia. TDL](https://en.wikipedia.org/wiki/Block-matching_algorithm#Two_Dimensional_Logarithmic_Search)
2. S. Metkar, S. Talbar, S. Metkar, S. Talbar, "Performance Evaluation of Block Matching Algorithms for Video Coding" in Motion Estimation Techniques for Digital Video Coding, India:Springer, 2013. [Ссылка](https://link.springer.com/chapter/10.1007/978-81-322-1097-9_2)
3. S. Soldatov, K. Strelnikov, D. Vatolin, "Low complexity global motion estimation from block motion vectors", Spring Conf. Comput. Graph., 2006. [Ссылка](http://www.graphicon.ru/oldgr/en/publications/text/ks_sccg06.pdf)
