# Машина фон Неймана
## Устройство репозитория и workflow
**Директория data/**  
Содержит набор текстовых файлов -- программ, написанных на псевдоассемблере.

**Директория translated/**  
Содержит набор бинарных файлов -- bytecode программ из директории _data_.

**Workflow**:
1. Написать программу _data/Х.txt_ на псевдоассемблере.
1. Сгенерировать bytecode программы _data/Х.txt_ в _translated/X.txt_.
    1. Изменить значение переменной `input_file_name` в файле _assembler.py_ на _X.txt_.
    1. Запустить _assembler.py_.
1. Запустить машину фон Неймана на файле _translated/X.txt_.
    1. Изменить значение переменной `input_file` в файле _machine.py_ на _X.txt_.
    1. Запустить _machine.py_.

## Псевдоассемблер
### Общие правила
#### Функции и метки. Блоки
* Каждая программа должна содержать функцию _.main_.
* С функции _.main_ начинается исполнение программы.
* Метки и функции условно разбивают программу на блоки.
* После блока функции _.main_ не должно идти никакого кода. Если есть необходимость в написании кода после функции _.main_, то В конце блока функции _.main_ должна явно вызываться команда выхода из программы.
* Блоки меток могут содержаться внутри блоков функций. Обратное возможно, но нежелательно.
* Блок желательно выделять отступом в 4 пробела.

#### Команды и унарные предикаты
* Все команды и унарные предикаты пишутся большими буквами.

#### Переменные
* Все переменные -- числовые.

#### Комментарии
* Строки, начинающиеся с символа '#', являются комментариями и полностью игнорируются компилятором.

### Список команд

| Команда                                               | Действие                                                                                                                                                                                                                                                                                     | Примечания                                                                                                                          |
|-------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------|
| GLOB {name}                                           | Определяет глобальную переменную с именем name.                                                                                                                                                                                                                                              | Все глобальные переменные должны объявляться в начале программы.                                                                    |
| VAR {name}                                            | Определяет локальную переменную с именем name.                                                                                                                                                                                                                                               | Все локальные переменные должны объявляться в начале блока функции.                                                                 |
| PRINT {name/number/string}                            | Печатает в консоль значение переменной _name_, числовой литерал _number_ или строковый литерал _string_. Курсор **не переносится** на новую строку.                                                                                                                                          | Строковые литералы должны заключаться в двойную пару кавычек разного типа: `'"hello"'` или `"'hello'"`.                             |
| PRINTLN {name/number/string}                          | Печатает в консоль значение переменной _name_, числовой литерал _number_ или строковый литерал _string_. Курсор **переносится** на новую строку.                                                                                                                                             | Строковые литералы должны заключаться в двойную пару кавычек разного типа: `'"hello"'` или `"'hello'"`.                             |
| READ -> {var}                                         | Считывает с консоли числовое значение и сохраняет его в переменную _var_.                                                                                                                                                                                                                    | -                                                                                                                                   |
| MOVE {varTarget} {varSource/number}                   | Копирует значение переменной _varSource_ или числовой литерал _number_ в переменную _varTarget_.                                                                                                                                                                                             | -                                                                                                                                   |
| ADD {argX} {argY} -> {varResult}                      | Складывает аргументы _argX_ и _argY_ и сохраняет результат в переменную _varResult_. _argX_ и _argY_ могут быть либо переменными, либо числовыми литералами.                                                                                                                                 | -                                                                                                                                   |
| SUB {argX} {argY} -> {varResult}                      | Вычитает аргументы _argX_ и _argY_ и сохраняет результат в переменную _varResult_. _argX_ и _argY_ могут быть либо переменными, либо числовыми литералами.                                                                                                                                   | -                                                                                                                                   |
| MUL {argX} {argY} -> {varResult}                      | Перемножает аргументы _argX_ и _argY_ и сохраняет результат в переменную _varResult_. _argX_ и _argY_ могут быть либо переменными, либо числовыми литералами.                                                                                                                                | -                                                                                                                                   |
| DIV {argX} {argY} -> {varResult}                      | Делит (целочисленно) аргумент _argX_ на _argY_ и сохраняет частное в переменную _varResult_. _argX_ и _argY_ могут быть либо переменными, либо числовыми литералами.                                                                                                                         | -                                                                                                                                   |
| MOD {argX} {argY} -> {varResult}                      | Делит (целочисленно) аргумент _argX_ на _argY_ и сохраняет остаток в переменную _varResult_. _argX_ и _argY_ могут быть либо переменными, либо числовыми литералами.                                                                                                                         | -                                                                                                                                   |
| LABEL {name}                                          | Определяет метку с именем _name_.                                                                                                                                                                                                                                                            | Названия меток желательно начинать с точки и составлять из маленьких букв.                                                          |
| JUMP {name}                                           | Выполняет безусловный переход по метке _name_.                                                                                                                                                                                                                                               | -                                                                                                                                   |
| IF {predicate} {var/number} {labelThen} [{labelElse}] | Если унарный предикат _predicate_ истинен на переменной _var_ или числовом литерале _number_, то выполняется переход по метке _labelThen_. Иначе, выполняется переход по _labelElse_. Если предикат оказался ложен, а _labelElse_ не указана, то программа переходит к следующей инструкции. | Возможные унарные предикаты перечислены в [следующем разделе](#Список-унарных-предикатов).                                          |
| FUN {name} [{arg1} [{arg2} [...]]]                    | Определяет функцию с именем _name_ и аргументами с именами _arg1_, _arg2_ и т.д.                                                                                                                                                                                                             | Названия функций желательно начинать с точки и составлять из маленьких букв. Функция без аргументов является частным случаем метки. |
| CALL {name} [{arg1} [{arg2} [...]]] -> {varResult}    | Вызывает функцию _name_, передавая в качестве аргументов _arg1_, _arg2_ и т.д. Результат вызова функции сохраняется в переменную _varResult_. Аргументы _arg1_, _arg2_, ... могут быть либо переменными, либо числовыми литералами.                                                          | -                                                                                                                                   |
| RET {var/number}                                      | Выполняет выход из функции, возвращая значение переменной _var_ или числовой литерал _number_.                                                                                                                                                                                               | -                                                                                                                                   |
| EXIT                                                  | Выполняет аварийный выход из программы.                                                                                                                                                                                                                                                      | Использование нежелательно.                                                                                                         |

### Список унарных предикатов

| Унарный предикат | Описание                |
|------------------|-------------------------|
| EQ0              | Равно нулю?             |
| G0               | Больше нуля?            |
| L0               | Меньше нуля?            |
| GE0              | Больше либо равно нулю? |
| LE0              | Меньше либо равно нулю? |
| NEQ0             | Не равно нулю?          |

## Bytecode
### Инструкции
Каждая инструкция занимает 6 байт:
* 1 байт -- опкод (код операции).
* 1 байт -- флаг операции.  
Оставшиеся два байта могут интерпретироваться одним из двух способов в зависимости от операции:  
* 2 + 2 байта -- два адреса _addr0_ и _addr1_, т.е. два номера какой-либо инструкции в бинарном образе программы.
* 4 байта -- числовое значение _value_.

В таблице ниже используется обозначение ^addr, где _addr_ -- некоторый адрес в образе программы. Оно означает разыменование, т.е. взятие значения из инструкции с адресом _addr_.

| Операция | Опкод | Флаг                                                                                                                                                                                                                                                                                                       | Описание инструкции или реакции машины на нее                                                                                                                                                                                                                            |
|----------|-------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| GLOB     | 1     | 0                                                                                                                                                                                                                                                                                                          | Хранит значение глобальной переменной в _value_.                                                                                                                                                                                                                         |
| STACK    | 2     | 0                                                                                                                                                                                                                                                                                                          | Хранит значение переменной, расположенной на стеке, в _value_.                                                                                                                                                                                                           |
| PUSH     | 3     | 0: `stack_value = value`;<br>1: `stack_value = ^arg1`;<br>2: `stack_value =^^arg1`.                                                                                                                                                                                                                              | Добавляет на стек инструкцию STACK со значением _stack\_value_. _stack\_value_ определяется флагом.                                                                                                                                                                      |
| POP      | 4     | 0                                                                                                                                                                                                                                                                                                          | Удаляет со стека инструкцию.                                                                                                                                                                                                                                             |
| MOVE     | 5     | 0..3, 7: не возможны;<br>4: `source = arg1`, `target = ^arg0`;<br>5: `source = ^arg1`, `target = ^arg0`;<br>6: `source = ^^arg1`, `target = ^arg0`;<br>8: `source =arg1`, `target = ^^arg0`;<br>9: `source = ^arg1`, `target =^^arg0`;<br>10: `source = ^^arg1`, `target =^^arg0`.                                           | Копирует значение из _source_ в _target_. _source_ и _target_ определяются флагом.                                                                                                                                                                                       |
| JUMP     | 6     | 0: `new = arg1`;<br>1: `new = ^arg1`;<br>2: `new = ^^arg1`.                                                                                                                                                                                                                                                      | Меняет адрес текущей инструкции на _new_. _new_ определяется флагом.                                                                                                                                                                                                     |
| CJUMP    | 7     | 0: EQ0, ветки else нет;<br>1: G0, ветки else нет;<br>2: L0, ветки else нет;<br>3: GE0, ветки else нет;<br>4: LE0, ветки else нет;<br>5: NEQ0, ветки else нет;<br>16: EQ0, ветка else есть;<br>17: G0, ветка else есть;<br>18: L0, ветка else есть;<br>19: GE0, ветка else есть;<br>20: LE0, ветка else есть;<br>21: NEQ0, ветка else есть;<br> | Если предикат от глобальной переменной AG (см. в [след. разделе](#Устройство-образа-программы)) истинен, то меняет адрес текущей инструкции на _addr1_. Если предикат ложен и есть ветка else, то -- на _addr0_. Наличие ветки else и вид предиката определяются флагом. |
| ADD      | 8     | 3, 7: не возможны;<br>0: `x = arg1`, `y = arg0`;<br>1: `x = ^arg1`, `y = arg0`;<br>2: `x = ^^arg1`, `y = arg0`;<br>4: `x = arg1`, `y = ^arg0`;<br>5: `x = ^arg1`, `y = ^arg0`;<br>6: `x = ^^arg1`, `y = ^arg0`;<br>8: `x = arg1`, `y = ^^arg0`;<br>9: `x = ^arg1`, `y =^^arg0`;<br>10: `x = ^^arg1`, `y =^^arg0`.                     | Складывает _x_ и _y_ и кладет результат в глобальную переменную AG (см. в [след. разделе](#Устройство-образа-программы)). _x_ и _y_ определяются флагом.                                                                                                                 |
| SUB      | 9     | 3, 7: не возможны;<br>0: `x = arg1`, `y = arg0`;<br>1: `x = ^arg1`, `y = arg0`;<br>2: `x = ^^arg1`, `y = arg0`;<br>4: `x = arg1`, `y = ^arg0`;<br>5: `x = ^arg1`, `y = ^arg0`;<br>6: `x = ^^arg1`, `y = ^arg0`;<br>8: `x = arg1`, `y = ^^arg0`;<br>9: `x = ^arg1`, `y =^^arg0`;<br>10: `x = ^^arg1`, `y =^^arg0`.                     | Вычитает из _x_ _y_ и кладет результат в глобальную переменную AG (см. в [след. разделе](#Устройство-образа-программы)). _x_ и _y_ определяются флагом.                                                                                                                  |
| MUL      | 10    | 3, 7: не возможны;<br>0: `x = arg1`, `y = arg0`;<br>1: `x = ^arg1`, `y = arg0`;<br>2: `x = ^^arg1`, `y = arg0`;<br>4: `x = arg1`, `y = ^arg0`;<br>5: `x = ^arg1`, `y = ^arg0`;<br>6: `x = ^^arg1`, `y = ^arg0`;<br>8: `x = arg1`, `y = ^^arg0`;<br>9: `x = ^arg1`, `y =^^arg0`;<br>10: `x = ^^arg1`, `y =^^arg0`.                     | Перемножает _x_ и _y_ и кладет результат в глобальную переменную AG (см. в [след. разделе](#Устройство-образа-программы)). _x_ и _y_ определяются флагом.                                                                                                                |
| DIV      | 11    | 3, 7: не возможны;<br>0: `x = arg1`, `y = arg0`;<br>1: `x = ^arg1`, `y = arg0`;<br>2: `x = ^^arg1`, `y = arg0`;<br>4: `x = arg1`, `y = ^arg0`;<br>5: `x = ^arg1`, `y = ^arg0`;<br>6: `x = ^^arg1`, `y = ^arg0`;<br>8: `x = arg1`, `y = ^^arg0`;<br>9: `x = ^arg1`, `y =^^arg0`;<br>10: `x = ^^arg1`, `y =^^arg0`.                     | Делит (целочисленно) _x_ на _y_ и кладет частное в глобальную переменную AG (см. в [след. разделе](#Устройство-образа-программы)). _x_ и _y_ определяются флагом.                                                                                                        |
| MOD      | 12    | 3, 7: не возможны;<br>0: `x = arg1`, `y = arg0`;<br>1: `x = ^arg1`, `y = arg0`;<br>2: `x = ^^arg1`, `y = arg0`;<br>4: `x = arg1`, `y = ^arg0`;<br>5: `x = ^arg1`, `y = ^arg0`;<br>6: `x = ^^arg1`, `y = ^arg0`;<br>8: `x = arg1`, `y = ^^arg0`;<br>9: `x = ^arg1`, `y =^^arg0`;<br>10: `x = ^^arg1`, `y =^^arg0`.                     | Делит (целочисленно) _x_ на _y_ и кладет остаток в глобальную переменную AG (см. в [след. разделе](#Устройство-образа-программы)). _x_ и _y_ определяются флагом.                                                                                                        |
| PRINT    | 13    | 0: `print_value = value`;<br>1: `print_value = ^addr1`;<br>2: `print_value = ^^addr1`;<br>3: `print_value = chr(value)`.<br>`chr(num)` -- возвращает символ с кодом _num_.                                                                                                                                             | Печатает _print\_value_ в консоль. _print\_value_ определяется флагом.                                                                                                                                                                                                   |
| READ     | 14    | 1: `target = ^addr1`;<br>2: `target = ^^addr1`.                                                                                                                                                                                                                                                               | Считывает с консоли числовое значение и сохраняет его в _target_. _target_ определяется флагом.                                                                                                                                                                          |
| STOP     | 15    | 0                                                                                                                                                                                                                                                                                                          | Останавливает работу машины фон Неймана.                                                                                                                                                                                                                                 |

### Устройство образа программы
Инструкции в бинарном образе программы идут в строгой последовательности.

| Адрес                 | Название     | Примечание                                                                                               |
|-----------------------|--------------|----------------------------------------------------------------------------------------------------------|
| 0                     | GLOB ip      | Instruction pointer -- адрес текущей команды.                                                            |
| 6                     | GLOB sp      | Stack pointer -- адрес верхушки стека.                                                                   |
| 12                    | GLOB ag      | Arithmetic glob -- глобальная переменная для сохранения результатов вычислений и промежуточных значений. |
| 18                    | GLOB tmp     | Temporary glob -- еще одна вспомогательная ячейка для случаев, когда _ag_ недостаточно.                  |
| 24                    | GLOB g_0     | Глобальная переменная 0.                                                                                 |
| ...                   | ...          | ...                                                                                                      |
| 24 + 6(k - 1)         | GLOB g_{k-1} | Глобальная переменная k-1.                                                                               |
| 24 + 6k               | instr_0      | Функциональная инструкция 0 (т.е. та, на которую реагирует машина).                                      |
| ...                   | ...          | ...                                                                                                      |
| 24 + 6k + 6(i-1)      | instr_{i-1}  | Функциональная инструкция i-1.                                                                           |
| 24 + 6k + 6i          | STACK_0      | Значение 0, располагаемое на стеке.                                                                      |
| ...                   | ...          | ...                                                                                                      |
| 24 + 6k + 6i + 6(n-1) | STACK_{n-1}  | Значение n-1, располагаемое на стеке.                                                                    |

## Ссылки
Все таблицы были сгенерированы с использованием [tablesgenerator](http://www.tablesgenerator.com/markdown_tables#).
