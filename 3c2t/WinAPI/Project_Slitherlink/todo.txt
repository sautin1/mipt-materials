1) добавить кастомизацию крестика
2) Избавиться от DFS:
хранить сет концов линий + мап из ребра в номер линии
3) просмотреть код на наличие схожих функций